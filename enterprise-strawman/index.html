<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<title>enterprise: Strawman Proposal &mdash; remexre.xyz</title>
		<link rel="stylesheet" type="text/css" href="https:&#x2F;&#x2F;remexre.xyz&#x2F;css/main.css">
		
	</head>
	<body>
		<header>
			<a class="subtle" href="https:&#x2F;&#x2F;remexre.xyz&#x2F;">Home</a>
			<a class="subtle" href="https:&#x2F;&#x2F;remexre.xyz&#x2F;tags">Tags</a>
			<a class="subtle" href="https:&#x2F;&#x2F;remexre.xyz&#x2F;contact">Contact</a>
			<a class="subtle" href="https://github.com/remexre">GitHub</a>
		</header>
		<div class="spacer"></div>
		
<article>
	<h1 class="title">
		<a class="subtle" href="https:&#x2F;&#x2F;remexre.xyz&#x2F;enterprise-strawman&#x2F;">enterprise: Strawman Proposal</a>
		<span class="spacer"></span>
		<span class="meta">
			Draft</span>
	</h1>
	<p>A friend (<a href="https://iptq.io/">Michael Zhang</a>) and I may be working on a web framework for Rust, <a href="https://crates.io/crates/enterprise"><code>enterprise</code></a>. This post serves as a strawman proposal for this framework, and as documentation for what the framework may eventually be.</p>
<p>Also note that despite the authorial &quot;we,&quot; this is almost entirely my vision (hence the S-expressions, use of Prolog, etc.), so expect this to be a strawman that's lit aflame rather than fortified.</p>
<h1 id="introduction">Introduction</h1>
<p>The model we use for webapps is described by a dependency diagram:</p>
<pre style="background-color:#272822;">
<span style="font-style:italic;color:#66d9ef;">digraph </span><span style="color:#e6db74;">&quot;dependency graph&quot; </span><span style="color:#f8f8f2;">{
	</span><span style="font-style:italic;color:#66d9ef;">graph</span><span style="color:#f8f8f2;">[</span><span style="color:#66d9ef;">bgcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#1e1f29&quot;</span><span style="color:#f8f8f2;">];

	BLogic[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#8be9fe&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#8be9fe&quot; </span><span style="color:#66d9ef;">label</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;Business</span><span style="color:#ae81ff;">\n</span><span style="color:#e6db74;">Logic&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#business-logic&quot;</span><span style="color:#f8f8f2;">];
	Actions[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#8be9fe&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#8be9fe&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#actions&quot;</span><span style="color:#f8f8f2;">];
	Schema[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#8be9fe&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#8be9fe&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#schema&quot;</span><span style="color:#f8f8f2;">];
	Views[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4cb4&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4cb4&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#views&quot;</span><span style="color:#f8f8f2;">];
	ViewAdapters[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">label</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;View</span><span style="color:#ae81ff;">\n</span><span style="color:#e6db74;">Adapters&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#view-adapters&quot;</span><span style="color:#f8f8f2;">];
	Authentication[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#authentication&quot;</span><span style="color:#f8f8f2;">];
	Authorization[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4cb4&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4cb4&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#authorization&quot;</span><span style="color:#f8f8f2;">];

	Actions -&gt; Schema [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4346&quot;</span><span style="color:#f8f8f2;">];
	Authorization -&gt; Actions [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4346&quot;</span><span style="color:#f8f8f2;">];
	Authorization -&gt; Authentication [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4346&quot;</span><span style="color:#f8f8f2;">];
	Authorization -&gt; Schema [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4346&quot;</span><span style="color:#f8f8f2;">];
	BLogic -&gt; Actions [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4346&quot;</span><span style="color:#f8f8f2;">];
	BLogic -&gt; Authentication [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4346&quot;</span><span style="color:#f8f8f2;">];
	BLogic -&gt; Schema [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4346&quot;</span><span style="color:#f8f8f2;">];
	Views -&gt; Authentication [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4346&quot;</span><span style="color:#f8f8f2;">];
	Views -&gt; Schema [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4346&quot;</span><span style="color:#f8f8f2;">];
	Views -&gt; ViewAdapters [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4346&quot;</span><span style="color:#f8f8f2;">];
}
</span></pre>
<p>As well as a dataflow diagram for server-side rendering:</p>
<pre style="background-color:#272822;">
<span style="font-style:italic;color:#66d9ef;">digraph </span><span style="color:#e6db74;">&quot;dataflow graph&quot; </span><span style="color:#f8f8f2;">{
	</span><span style="font-style:italic;color:#66d9ef;">graph</span><span style="color:#f8f8f2;">[</span><span style="color:#66d9ef;">bgcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#1e1f29&quot;</span><span style="color:#f8f8f2;">];

	HTTP[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#cfcfcf&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#cfcfcf&quot; </span><span style="color:#66d9ef;">shape</span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;">plaintext];
	Databases[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#cfcfcf&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#cfcfcf&quot; </span><span style="color:#66d9ef;">label</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;Databases and</span><span style="color:#ae81ff;">\n</span><span style="color:#e6db74;">External Services&quot; </span><span style="color:#66d9ef;">shape</span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;">plaintext];

	Authorization[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4cb4&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4cb4&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#authorization&quot;</span><span style="color:#f8f8f2;">];
	Actions[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#8be9fe&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#8be9fe&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#actions&quot;</span><span style="color:#f8f8f2;">];
	BLogic[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#8be9fe&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#8be9fe&quot; </span><span style="color:#66d9ef;">label</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;Business</span><span style="color:#ae81ff;">\n</span><span style="color:#e6db74;">Logic&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#business-logic&quot;</span><span style="color:#f8f8f2;">];
	DAL[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#data-access-layer&quot;</span><span style="color:#f8f8f2;">];
	Router[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#router&quot;</span><span style="color:#f8f8f2;">];
	ViewAdapters[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">label</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;View</span><span style="color:#ae81ff;">\n</span><span style="color:#e6db74;">Adapters&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#view-adapters&quot;</span><span style="color:#f8f8f2;">];
	Views[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4cb4&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#fc4cb4&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#views&quot;</span><span style="color:#f8f8f2;">];
	Authentication[</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">fontcolor</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#f0fb8c&quot; </span><span style="color:#66d9ef;">URL</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#authentication&quot;</span><span style="color:#f8f8f2;">];

	{</span><span style="color:#66d9ef;">rank</span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;">same; Authentication, ViewAdapters};
	{</span><span style="color:#66d9ef;">rank</span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;">same; BLogic, Views};
	{</span><span style="color:#66d9ef;">rank</span><span style="color:#f92672;">=</span><span style="color:#f8f8f2;">same; Actions, Authorization};

	HTTP -&gt; Router [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#cfcfcf&quot;</span><span style="color:#f8f8f2;">];
	Router -&gt; HTTP [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#cfcfcf&quot;</span><span style="color:#f8f8f2;">];
	Databases -&gt; DAL [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#cfcfcf&quot;</span><span style="color:#f8f8f2;">];
	DAL -&gt; Databases [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#cfcfcf&quot;</span><span style="color:#f8f8f2;">];

	</span><span style="color:#75715e;">// When the router gets a request, it passes it to the business logic,
	// along with the results of authentication.
</span><span style="color:#f8f8f2;">	Router -&gt; BLogic [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];
	Router -&gt; Authentication [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];
	Authentication -&gt; BLogic [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];

	</span><span style="color:#75715e;">// The business logic performs actions (and gets data from them).
</span><span style="color:#f8f8f2;">	BLogic -&gt; Actions [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];
	Actions -&gt; BLogic [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];

	</span><span style="color:#75715e;">// Actions are allowed or disallowed based on the results of
	// authorization, which is also informed by authentication and the
	// database (via the DAL).
</span><span style="color:#f8f8f2;">	Authentication -&gt; Authorization [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];
	Authorization -&gt; Actions [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];
	DAL -&gt; Authorization [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];

	</span><span style="color:#75715e;">// Actions communicate with the database via the DAL.
</span><span style="color:#f8f8f2;">	Actions -&gt; DAL [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];
	DAL -&gt; Actions [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];

	</span><span style="color:#75715e;">// The business logic then communicates the response to views, which
	// are rendered with view adapters, which then send a rendered response
	// to the router.
</span><span style="color:#f8f8f2;">	BLogic -&gt; Views [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];
	Views -&gt; ViewAdapters [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];
	ViewAdapters -&gt; Router [</span><span style="color:#66d9ef;">color</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&quot;#50fb7c&quot;</span><span style="color:#f8f8f2;">];
}
</span></pre>
<p>In the above diagrams, <span style="color: #f0fb8c">yellow</span> components are provided by <code>enterprise</code>, <span style="color: #8be9fe">blue</span> components are written by the application author in Rust, and <span style="color: #fc4cb4">pink</span> components are written by the application author in a DSL.</p>
<p>The Schema and DAL components are taken from <a href="https://www.tedinski.com/2018/09/11/stateless-mvc.html">Ted Kaminski's &quot;Stateless MVC,&quot;</a> which describes them in detail.</p>
<h1 id="schema">Schema</h1>
<p>The Schema component contains type declarations for each of the &quot;domain objects.&quot; If a type ends up being sent over the network, it should probably be declared here. <a href="https://iptq.io/magic-forms-with-proc-macros/">Derive macros</a> are provided to allow the Router to validate these values.</p>
<p>The only exports of the Schema should be types -- if you find yourself exporting functions, they probably belong in the business logic.</p>
<h1 id="actions">Actions</h1>
<p>Actions are the atomic primitive functions that are used to define the business logic. Macros are available to define CRUD actions for types in the Schema (relative to some data store supported by the DAL).</p>
<h1 id="business-logic">Business Logic</h1>
<p>The Business Logic module transforms requests into data that can be handled directly by a View.</p>
<h1 id="views">Views</h1>
<p>Views are written in a React-like DSL.</p>
<h1 id="view-adapters">View Adapters</h1>
<p>View Adapters are backends for Views -- one exists to translate to HTML, another to translate to JSON, and another that performs tree-diffing to efficiently update HTML.</p>
<h1 id="auth">Auth</h1>
<p>The generic phrase &quot;auth&quot; confusingly can refer to either &quot;authentication&quot; or &quot;authorization.&quot; These are conflated both by the term and in many people's heads, so we avoid it, and make a strong split between the two.</p>
<h2 id="authentication">Authentication</h2>
<p>Authentication is the answer to the question &quot;what user does this request correspond to?&quot; As with other parts of a web application, <code>enterprise</code> simplifies authentication by abstracting it heavily.</p>
<p>For our app, we want to allow a plethora of authentication methods, while also allowing a user to have multiple authentication methods. (This is useful since a user might forget whether they registered with their Google account or email, and it allows an anonymous user to add an email and stop being anonymous!)</p>
<p>In <code>app.sexp</code>:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">(authentication
  (multiple true)
  (providers
    anonymous</span><span style="color:#f92672;">-</span><span style="color:#f8f8f2;">cookie
    (email</span><span style="color:#f92672;">-</span><span style="color:#f8f8f2;">password :reset email)
    oauth</span><span style="color:#f92672;">-</span><span style="color:#f8f8f2;">facebook
    oauth</span><span style="color:#f92672;">-</span><span style="color:#f8f8f2;">google
    oauth</span><span style="color:#f92672;">-</span><span style="color:#f8f8f2;">twitter))
</span></pre>
<p>In <code>views/login.sexp</code>:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">TODO
</span></pre><h2 id="authorization">Authorization</h2>
<p>Authorization is the answer to the question &quot;can this user perform this action?&quot; This is almost entirely application-specific, so we leave the logic here to the app author.</p>
<p>But wait, we're using logic on a question with a boolean answer? Well, I know the best way to do this! <code>enterprise</code> apps specify authorization information with a Prolog dialect.</p>
<p>For our app, TODO.</p>
<p>In <code>src/authorization.pro</code>:</p>
<pre style="background-color:#272822;">
<span style="color:#a6e22e;">authorized</span><span style="color:#f8f8f2;">(UserID</span><span style="color:#f92672;">,</span><span style="color:#f8f8f2;"> Action)</span><span style="color:#f92672;">. </span><span style="color:#75715e;"># TODO
</span></pre>
</article>
<div class="comments">
		Comments are not enabled on this post.
	</div>

		<div class="spacer"></div>
		
<script src="https:&#x2F;&#x2F;remexre.xyz&#x2F;ext/anchor.min.js"></script>
<script>
	const anchors = new AnchorJS();
	anchors.options.class = "icon subtle";
	anchors.options.placement = "left";
	anchors.add("article h1:not(.title)");
</script>

	</body>
</html>
